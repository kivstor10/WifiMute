version: 1
# This is a highly defensive configuration to combat the persistent EEXIST error.
# It aggressively cleans up old files and uses explicit paths to ensure the correct
# Node.js version and tools are used in each phase.

backend:
  phases:
    install:
      runtime-versions:
        nodejs: 22
      commands:
        - echo "--- Backend Install Phase ---"
        - . "$NVM_DIR/nvm.sh"
        - nvm install 22
        - nvm use 22
        - echo "Node version set to:"
        - node -v
        # Debugging: List the contents of the problematic directory before cleaning.
        - echo "Listing contents of old Node 18 bin before cleanup:"
        - ls -la /root/.nvm/versions/node/v18.20.8/bin/ || echo "Old bin directory not found."
        # Aggressively find and remove ANY 'amplify' binary from nvm's directories.
        - echo "Searching for and removing pre-existing 'amplify' binaries..."
        - find /root/.nvm/versions/node/ -type f -name "amplify" -exec rm -f {} \;
        - echo "Cleanup complete."
        # Debugging: List the contents again to confirm removal.
        - echo "Listing contents of old Node 18 bin after cleanup:"
        - ls -la /root/.nvm/versions/node/v18.20.8/bin/ || echo "Old bin directory not found."
        - echo "--- End of Backend Install Phase ---"
    build:
      commands:
        - echo "--- Backend Build Phase ---"
        # Re-initialize nvm for this phase to ensure a clean shell state, as build phases can be separate.
        - . "$NVM_DIR/nvm.sh"
        - nvm use 22
        - echo "Node version for build phase:"
        - node -v
        # KEY FIX: Use the explicit, absolute path to the Node 22 'npx' binary.
        # This avoids any PATH issues and guarantees we are using the correct version's tool.
        - NPX_PATH="$(dirname $(nvm which 22))/npx"
        - echo "Using npx from: $NPX_PATH"
        - $NPX_PATH --package=@aws-amplify/backend-cli@latest ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        - echo "Backend deployment command executed successfully."

frontend:
  phases:
    preBuild:
      commands:
        - echo "--- Frontend preBuild Phase ---"
        - . "$NVM_DIR/nvm.sh"
        - nvm use 22
        - echo "Node version for frontend:"
        - node -v
        - npm ci
        - echo "Frontend dependencies installed with npm ci."
    build:
      commands:
        - echo "--- Frontend Build Phase ---"
        - npm run build
        - echo "Frontend build completed."
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      # Caching node_modules and the npm cache directory can speed up subsequent builds.
      - node_modules/**/*
      - .npm/**/*
