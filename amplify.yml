version: 1


backend:
  phases:
    install:
      runtime-versions:
        nodejs: 22
      commands:
        - echo "--- Backend Install Phase ---"
        - . "$NVM_DIR/nvm.sh"
        - nvm install 22
        - nvm use 22
        - echo "Node version set to:"
        - node -v

        - echo "Listing contents of old Node 18 bin before cleanup:"
        - ls -la /root/.nvm/versions/node/v18.20.8/bin/ || echo "Old bin directory not found."

        - echo "Searching for and removing pre-existing 'amplify' binaries..."
        - find /root/.nvm/versions/node/ -type f -name "amplify" -exec rm -f {} \;
        - echo "Cleanup complete."

        - echo "Listing contents of old Node 18 bin after cleanup:"
        - ls -la /root/.nvm/versions/node/v18.20.8/bin/ || echo "Old bin directory not found."
        - echo "--- End of Backend Install Phase ---"
    build:
      commands:
        - echo "--- Backend Build Phase ---"

        - . "$NVM_DIR/nvm.sh"
        - nvm use 22
        - echo "Node version for build phase:"
        - node -v

        - NPX_PATH="$(dirname $(nvm which 22))/npx"
        - echo "Using npx from: $NPX_PATH"
        - $NPX_PATH --package=@aws-amplify/backend-cli@latest ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        - echo "Backend deployment command executed successfully."

frontend:
  phases:
    preBuild:
      commands:
        - echo "--- Frontend preBuild Phase ---"
        - . "$NVM_DIR/nvm.sh"
        - nvm use 22
        - echo "Node version for frontend:"
        - node -v
        - npm ci
        - echo "Frontend dependencies installed with npm ci."
    build:
      commands:
        - echo "--- Frontend Build Phase ---"
        - npm run build
        - echo "Frontend build completed."
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:

      - node_modules/**/*
      - .npm/**/*