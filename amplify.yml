version: 1
backend:
  phases:
    install:
      runtime-versions:
        nodejs: 22
      commands:
        - echo "--- BEGINNING OF INSTALL PHASE COMMANDS ---"

        # Explicitly clear Node.js cache and node_modules to ensure a fresh install
        # This will make builds slower initially but helps diagnose cache issues.
        - rm -rf .npm
        - rm -rf node_modules
        - echo "Cleaned up .npm and node_modules"

        # Ensure nvm is sourced and available
        - |
          # Check common NVM paths and source it
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
          elif [ -s "/usr/local/nvm/nvm.sh" ]; then
            . "/usr/local/nvm/nvm.sh"
          fi
          echo "NVM sourced."

        # Install and use Node.js 22
        - nvm install 22 || echo "nvm install 22 command failed, check nvm setup."
        - nvm use 22 || echo "nvm use 22 command failed, check nvm setup."
        - node -v # VERIFY NODE VERSION HERE
        - npm -v  # VERIFY NPM VERSION HERE
        - echo "Node.js version check complete in install phase."

        # Now run npm ci, knowing Node.js 22 is active
        - npm ci --cache .npm --prefer-offline 
        - echo "npm ci completed in install phase."

        # Install Amplify backend CLI globally right after npm ci
        - npm install -g @aws-amplify/backend-cli@latest 
        - echo "Amplify backend CLI installed in install phase."

        - echo "--- END OF INSTALL PHASE COMMANDS ---"
    
    # Remove the 'build' phase for this debugging step to force all commands into 'install'
    build:
      commands:
        # Move the deploy command here as the final step.
        # All setup should be done by now.
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        - echo "Amplify deployment command executed."

frontend:
  phases:
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*